# PowerShell scripts for Microsoft SDS / Entra
PowerShell scripts to modify students and SDS classes in Microsoft Entra.

## Prerequisites

1. Change the execution policy for the current user to allow execution of all PowerShell scripts.

   ```
   powershell -Command "Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser"
   ```

1. Install the Microsoft Graph PowerShell SDK.

   ```
   powershell -Command "Install-Module Microsoft.Graph -Scope CurrentUser"
   ```

   Full instructions at https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation?view=graph-powershell-1.0.


## Extract students from Sycamore

```
python ..\sds\ExtractStudents.py --school 2132 --token [sycamore token] --cache cache --out out
```
This creates the `azure-ad-students.csv` in the specified `out` directory.


## General information
Scripts in this directory will execute in dry-run mode by default. When satisfied with the proposed actions, rerun them in non-dry-run mode by adding `-dryRun 0`.

On some scripts output verbosity can be increased by adding `-verboseOutput 1`.


## Regular sync operation

After extracting the students CSV, the following scripts should be executed in the given order:

```
powershell create-students.ps1 -csvFile out\azure-ad-students.csv
powershell set-students-accountenabled.ps1 -csvFile out\azure-ad-students.csv
```

The `create-students.ps` script can optionally add newly created students to an existing Entra group by using the `-addToGroup \[group name\]` parameter.

Remember to rerun the scripts with `-dryRun 0` when satisfied with the proposed actions.

## Start-of-year tasks

### Delete old groups
At the beginning of a school year old SDS classes (Entra groups) should be deleted:

```
powershell delete-groups.ps1 -prefixToDelete Exp0824_
```

This will delete all groups that start with `Exp0824_`. This prefix needs to be updated to match the prefix generated by the SDS end-of-year tasks from the previous-previous year, i.e. keep one year of group history.

Remember to rerun the script with `-dryRun 0` when satisfied with the proposed actions.

### Set student passwords
At the beginning of a school year we reset the passwords of all students to their default to match the information in the welcome letter:

```
powershell set-students-password.ps1 -csvFile out\azure-ad-students.csv
```

Remember to rerun the script with `-dryRun 0` when satisfied with the proposed actions.
